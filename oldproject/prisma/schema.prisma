// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  username      String   @unique
  passwordHash  String
  name          String
  role          Role     @default(STAFF)
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id])
  lineUserId    String?   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  comments      Comment[]
  activityLogs  ActivityLog[]
  createdWorkOrders WorkOrder[] @relation("CreatedBy")
  uploadedAttachments WorkAttachment[]

  @@index([departmentId])
  @@index([role])
}

model Department {
  id     String   @id @default(uuid())
  name   String   @unique
  users  User[]
  checkpoints        Checkpoint[]
  templateCheckpoints TemplateCheckpoint[]

  @@index([name])
}

model WorkOrder {
  id          String   @id @default(uuid())
  company     String
  title       String
  description String?
  priority    Priority @default(MEDIUM)
  createdById String
  createdBy   User @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  deadline    DateTime?
  checkpoints Checkpoint[]
  attachments WorkAttachment[]
  workComments Comment[] @relation("WorkComments")

  @@index([company])
  @@index([createdById])
  @@index([priority])
  @@index([deadline])
}

model Checkpoint {
  id            String   @id @default(uuid())
  workId        String
  work          WorkOrder @relation(fields: [workId], references: [id], onDelete: Cascade)
  order         Int
  name          String
  ownerDeptId   String
  ownerDept     Department @relation(fields: [ownerDeptId], references: [id])
  status        Status @default(PENDING)
  startedAt     DateTime?
  endedAt       DateTime?
  comments      Comment[] @relation("CheckpointComments")

  @@index([workId])
  @@index([ownerDeptId])
  @@index([status])
  @@index([order])
}

model Comment {
  id            String   @id @default(uuid())
  checkpointId  String?
  checkpoint    Checkpoint? @relation("CheckpointComments", fields: [checkpointId], references: [id], onDelete: Cascade)
  workId        String?
  work          WorkOrder? @relation("WorkComments", fields: [workId], references: [id], onDelete: Cascade)
  userId        String
  user          User @relation(fields: [userId], references: [id])
  message       String?
  fileUrl       String?
  parentId      String?
  parent        Comment? @relation("Replies", fields: [parentId], references: [id], onDelete: Cascade)
  replies       Comment[] @relation("Replies")
  mentionedUserIds String[] @default([])
  createdAt     DateTime @default(now())

  @@index([checkpointId])
  @@index([workId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
}

model WorkAttachment {
  id        String   @id @default(uuid())
  workId    String
  work      WorkOrder @relation(fields: [workId], references: [id], onDelete: Cascade)
  url       String
  uploadedById String
  uploadedBy User @relation(fields: [uploadedById], references: [id])
  createdAt DateTime @default(now())

  @@index([workId])
  @@index([uploadedById])
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  user      User @relation(fields: [userId], references: [id])
  action    String
  details   String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Template {
  id          String   @id @default(uuid())
  name        String
  checkpoints TemplateCheckpoint[]

  @@index([name])
}

model TemplateCheckpoint {
  id            String   @id @default(uuid())
  templateId    String
  template      Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  order         Int
  name          String
  ownerDeptId   String
  ownerDept     Department @relation(fields: [ownerDeptId], references: [id])

  @@index([templateId])
  @@index([ownerDeptId])
  @@index([order])
}

enum Role {
  ADMIN
  STAFF
  MANAGER
}

enum Status {
  PENDING
  PROCESSING
  COMPLETED
  RETURNED
  PROBLEM
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

