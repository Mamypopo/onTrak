
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Device Models
// ============================================

model Device {
  id            String   @id @default(uuid())
  deviceCode    String   @unique
  name          String?
  serialNumber  String?
  model         String?
  osVersion     String?
  lastSeen      DateTime @default(now())
  battery       Int      @default(0)
  wifiStatus    Boolean  @default(false)
  isCharging    Boolean  @default(false)
  batteryHealth String?
  chargingMethod String? // USB, AC, WIRELESS, NONE
  mobileDataEnabled Boolean @default(false)
  networkConnected Boolean @default(false)
  screenOn         Boolean  @default(false)
  volumeLevel      Int      @default(0)
  bluetoothEnabled Boolean  @default(false)
  installedAppsCount Int    @default(0)
  bootTime         BigInt?  
  latitude      Float?
  longitude     Float?
  kioskMode     Boolean  @default(false)
  status        DeviceStatus @default(OFFLINE)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  metrics       DeviceMetrics[]
  checkoutItems CheckoutItem[] // ใช้ Checkout แทน BorrowRecord
  actionLogs    DeviceActionLog[]
  locationHistory DeviceLocationHistory[]

  @@index([deviceCode])
  @@index([status])
  @@index([lastSeen])
  @@map("devices")
}

model DeviceMetrics {
  id           String   @id @default(uuid())
  deviceId     String
  cpu          Float    @default(0)
  memoryTotal  BigInt   @default(0)
  memoryUsed   BigInt   @default(0)
  memoryAvailable BigInt @default(0)
  storageTotal BigInt   @default(0)
  storageUsed  BigInt   @default(0)
  storageAvailable BigInt @default(0)
  networkType  String?
  foregroundApp String?
  createdAt    DateTime @default(now())

  device       Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([createdAt])
  @@map("device_metrics")
}

model DeviceActionLog {
  id          String   @id @default(uuid())
  deviceId    String
  userId      String?
  user        String?  // Keep for backward compatibility
  action      String
  payload     Json?
  createdAt   DateTime @default(now())

  device      Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  userRef     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([deviceId])
  @@index([action])
  @@index([createdAt])
  @@index([userId])
  @@index([deviceId, action, createdAt]) // Composite index สำหรับ query BOOT event ในวันนี้
  @@map("device_action_logs")
}

model DeviceLocationHistory {
  id        String   @id @default(uuid())
  deviceId  String
  latitude  Float
  longitude Float
  accuracy  Float?   // GPS accuracy in meters
  speed     Float?   // Speed in m/s (optional)
  heading   Float?   // Direction in degrees (optional)
  createdAt DateTime @default(now())

  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId, createdAt])
  @@index([createdAt]) // สำหรับ cron job ลบข้อมูลเก่า
  @@map("device_location_history")
}

// ============================================
// User Model
// ============================================

model User {
  id          String   @id @default(uuid())
  username    String   @unique
  email       String?  @unique
  password    String   // Hashed password
  fullName    String?
  role        UserRole @default(STAFF)
  isActive    Boolean  @default(true)
  lastLogin   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Checkout relations
  checkoutsCreated Checkout[] @relation("CheckoutCreatedBy")
  checkoutsBorrowed Checkout[] @relation("CheckoutBorrower") // ผู้เบิก
  checkoutItemsReturned CheckoutItem[] @relation("CheckoutItemReturnedBy")
  checkoutEvents CheckoutEvent[] @relation("CheckoutEventUser")

  // Other relations
  actionLogs    DeviceActionLog[]
  auditLogs     AuditLog[]

  @@index([username])
  @@index([email])
  @@index([role])
  @@map("users")
}

// ============================================
// Audit Log
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  username    String?
  action      String
  resource    String?
  resourceId  String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

model Checkout {
  id              String          @id @default(uuid())
  checkoutNumber  String          @unique // เลขที่การเบิก (เช่น CHK-2024-001)
  company         String?         // บริษัท/หน่วยงานที่เบิก
  borrowerId      String?         // ผู้เบิก (User ที่ยืมไปใช้)
  borrower        User?           @relation("CheckoutBorrower", fields: [borrowerId], references: [id], onDelete: SetNull)
  charger         Int?            // จำนวนที่ชาร์จ (จำนวน charger/power bank)
  startTime       DateTime        @default(now()) // วันที่และเวลาเริ่มใช้งาน
  endTime         DateTime?       // วันที่และเวลาสิ้นสุด (null = ยังไม่สิ้นสุด)
  expectedEndTime DateTime?       // เวลาที่คาดว่าจะคืน
  usageNotes      String?         // หมายเหตุการใช้งาน
  createdBy       String          // ผู้สร้าง checkout (อาจเป็นคนละคนกับผู้เบิก)
  creator         User            @relation("CheckoutCreatedBy", fields: [createdBy], references: [id])
  items           CheckoutItem[]
  events          CheckoutEvent[] // History ของทุกการเปลี่ยนแปลง
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  deletedAt       DateTime?       // Soft delete

  @@index([checkoutNumber])
  @@index([createdBy])
  @@index([borrowerId])
  @@index([startTime])
  @@index([endTime])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("checkouts")
}

model CheckoutItem {
  id              String          @id @default(uuid())
  checkoutId      String
  deviceId        String
  checkout        Checkout        @relation(fields: [checkoutId], references: [id], onDelete: Cascade)
  device          Device          @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  
  // ข้อมูลการคืน (immutable - ไม่แก้ไข แต่สร้าง record ใหม่)
  returnedAt      DateTime?       // เวลาคืนจริง (null = ยังไม่คืน)
  returnedBy      String?         // ผู้คืน
  returner        User?           @relation("CheckoutItemReturnedBy", fields: [returnedBy], references: [id], onDelete: SetNull)
  problem         String?         // ปัญหาที่พบ
  solution        String?         // วิธีแก้ไข
  maintenanceStatus MaintenanceStatus? // สถานะซ่อมบำรุง
  returnNotes     String?         // หมายเหตุการคืน
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([checkoutId, deviceId]) // ป้องกัน duplicate device ใน checkout เดียวกัน
  @@index([checkoutId])
  @@index([deviceId])
  @@index([returnedAt])
  @@index([maintenanceStatus])
  @@map("checkout_items")
}

// Event Sourcing - เก็บ history ของทุกการเปลี่ยนแปลง
model CheckoutEvent {
  id          String          @id @default(uuid())
  checkoutId  String
  checkout    Checkout        @relation(fields: [checkoutId], references: [id], onDelete: Cascade)
  eventType   CheckoutEventType
  userId      String?
  user        User?           @relation("CheckoutEventUser", fields: [userId], references: [id], onDelete: SetNull)
  username    String?         // Keep for backward compatibility
  deviceId    String?         // ถ้า event เกี่ยวกับ device เฉพาะ
  oldData     Json?           // ข้อมูลเก่า (สำหรับ undo)
  newData     Json?           // ข้อมูลใหม่
  notes       String?
  createdAt   DateTime        @default(now())

  @@index([checkoutId])
  @@index([eventType])
  @@index([createdAt])
  @@index([deviceId])
  @@map("checkout_events")
}

// ============================================
// Enums
// ============================================

enum DeviceStatus {
  ONLINE
  OFFLINE
}

enum UserRole {
  ADMIN
  STAFF
}

enum CheckoutStatus {
  ACTIVE          // กำลังเบิกอยู่ (มี item ที่ยังไม่คืน)
  PARTIAL_RETURN  // คืนบางส่วนแล้ว
  RETURNED        // คืนครบทุก device แล้ว
  CANCELLED       // ยกเลิก checkout
}

enum CheckoutEventType {
  CREATED           // สร้าง checkout
  ITEM_ADDED        // เพิ่ม device
  ITEM_REMOVED      // ลบ device (ก่อน checkout)
  CHECKED_OUT       // ยืนยันการเบิก
  ITEM_RETURNED     // คืน device
  ITEM_PROBLEM      // รายงานปัญหา
  ITEM_REPAIRED     // ซ่อมเสร็จ
  CANCELLED         // ยกเลิก checkout
  UPDATED           // แก้ไขข้อมูล
}

enum MaintenanceStatus {
  NONE              // ไม่มีปัญหา
  NEEDS_REPAIR      // ต้องซ่อม
  IN_MAINTENANCE    // กำลังซ่อม
  REPAIRED          // ซ่อมเสร็จแล้ว
  DAMAGED           // เสียหาย (ไม่สามารถซ่อมได้)
}

